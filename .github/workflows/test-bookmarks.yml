name: Test Bookmarks Workflow

on:
  workflow_dispatch: # Manual trigger only
  pull_request:
    branches: [main]

jobs:
  test-bookmarks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Run tests
      run: npm test

    - name: Test data branch setup
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git show-ref --quiet refs/remotes/origin/bookmarks-data; then
          echo "‚úÖ bookmarks-data branch exists"
          git checkout bookmarks-data
        else
          echo "‚úÖ Creating bookmarks-data branch"
          git checkout -b bookmarks-data
          mkdir -p data
          echo "# Test Data" > data/README.md
          git add data/README.md
          git commit -m "Test: Initialize bookmarks data branch"
        fi

    - name: Test bookmark fetch (if secrets available)
      env:
        RAINDROP_CLIENT_ID: ${{ secrets.RAINDROP_CLIENT_ID }}
        RAINDROP_CLIENT_SECRET: ${{ secrets.RAINDROP_CLIENT_SECRET }}
      run: |
        if [ ! -z "${{ secrets.RAINDROP_REFRESH_TOKEN }}" ]; then
          echo "üîë Creating tokens from secrets..."
          cat > tokens.json << EOF
        {
          "access_token": "${{ secrets.RAINDROP_ACCESS_TOKEN }}",
          "refresh_token": "${{ secrets.RAINDROP_REFRESH_TOKEN }}",
          "expires_at": "${{ secrets.RAINDROP_EXPIRES_AT }}"
        }
        EOF
          
          echo "üöÄ Testing bookmark fetch..."
          npm run fetch
          
          if [ -d "data" ] && [ "$(ls -A data/*.json 2>/dev/null)" ]; then
            echo "‚úÖ Individual bookmark files created:"
            ls data/*.json | head -5
          else
            echo "‚ö†Ô∏è No bookmark files created"
          fi
        else
          echo "‚ö†Ô∏è No secrets configured - skipping real fetch test"
        fi